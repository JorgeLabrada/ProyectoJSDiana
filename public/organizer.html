<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Organizador</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <span class="navbar-brand">Panel del Organizador</span>
    </div>
  </nav>

  <main class="container my-4">
    <div class="row justify-content-center">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title">Configurar sesión</h5>

            <div class="mb-3">
              <label class="form-label">Opciones (separadas por comas)</label>
              <input id="options" class="form-control" placeholder="A,B,C" value="A,B" />
            </div>

            <div class="mb-3">
              <label class="form-label">Duración (segundos)</label>
              <input id="duration" type="number" class="form-control" value="60" />
            </div>

            <div class="d-flex align-items-center gap-2 mb-3">
              <button id="start" class="btn btn-primary">Iniciar sesión</button>
              <span id="sessionInfo" class="badge text-bg-info"></span>
            </div>

            <div id="share" class="alert alert-secondary d-none" role="alert">
              <div class="d-flex flex-column gap-2">
                <div>
                  <span class="fw-semibold">Código:</span>
                  <span id="code" class="badge text-bg-dark"></span>
                </div>
                <div class="input-group">
                  <input id="link" class="form-control" readonly />
                  <button id="copy" class="btn btn-outline-secondary">Copiar</button>
                </div>
              </div>
            </div>

            <hr/>
            <h6>Conteo en vivo</h6>
            <pre id="tally" class="bg-body-secondary p-3 rounded">{}</pre>
            <div id="total" class="fw-semibold"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
    const host = location.host;
    const url = `${protocol}://${host}/mqtt`;
    const client = mqtt.connect(url);

    const optionsInput = document.getElementById('options');
    const durationInput = document.getElementById('duration');
    const startBtn = document.getElementById('start');
    const sessionInfo = document.getElementById('sessionInfo');
    const tallyPre = document.getElementById('tally');
    const totalDiv = document.getElementById('total');
    const shareBox = document.getElementById('share');
    const codeSpan = document.getElementById('code');
    const linkInput = document.getElementById('link');
    const copyBtn = document.getElementById('copy');

    let currentSessionId = null;
    let currentCode = null;

    client.on('connect', () => {
      client.subscribe('voting/session');
      client.subscribe('voting/tally');
    });

    client.on('message', (topic, payload) => {
      const data = JSON.parse(payload.toString());
      if (topic === 'voting/session') {
        if (data.type === 'started') {
          currentSessionId = data.sessionId;
          currentCode = data.code || currentCode;
          sessionInfo.textContent = `Sesión ${data.code || data.sessionId} termina en ${Math.ceil((data.endAt - Date.now())/1000)}s`;
          if (currentCode) {
            codeSpan.textContent = currentCode;
            linkInput.value = `${location.origin}/vote/${currentCode}`;
            shareBox.classList.remove('d-none');
          }
          tallyPre.textContent = '{}';
          totalDiv.textContent = '';
        } else if (data.type === 'ended') {
          if (currentSessionId === data.sessionId) {
            sessionInfo.textContent = `Sesión ${data.sessionId} finalizada`;
          }
        }
      } else if (topic === 'voting/tally') {
        tallyPre.textContent = JSON.stringify(data.tally, null, 2);
        totalDiv.textContent = `Votos totales: ${data.totalVotes}`;
      }
    });

    startBtn.onclick = async () => {
      const options = optionsInput.value.split(',').map(s => s.trim()).filter(Boolean);
      const durationSeconds = Number(durationInput.value);
      const resp = await fetch('/api/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ options, durationSeconds })
      });
      const data = await resp.json();
      if (data.ok) {
        currentSessionId = data.sessionId;
        currentCode = data.code;
        sessionInfo.textContent = `Sesión ${data.code} termina en ${Math.ceil((data.endAt - Date.now())/1000)}s`;
        codeSpan.textContent = currentCode;
        linkInput.value = `${location.origin}${data.link}`;
        shareBox.classList.remove('d-none');
      } else {
        alert('Error: ' + (data.error || 'No se pudo iniciar'));
      }
    };

    copyBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(linkInput.value);
        copyBtn.textContent = 'Copiado';
        setTimeout(() => (copyBtn.textContent = 'Copiar'), 1500);
      } catch (e) {
        linkInput.select();
        document.execCommand('copy');
      }
    };
  </script>
</body>
</html>
